services:
  gateway:
    build: ./sandol-gateway/gateway
    ports:
      - "8010:80"
    environment:
      - SECRET_KEY=${SECRET_KEY}
    depends_on:
      - user-service
      - meal-service
      - kakao-bot-service
      - static-info-service
    volumes:
      - ./sandol-gateway/gateway:/etc/nginx/conf.d
      - ./sandol-gateway/gateway/lua:/etc/nginx/lua
      - user_static:/usr/share/nginx/static/user
    command: [ "/usr/local/openresty/bin/openresty", "-g", "env SECRET_KEY; daemon off;" ]
    networks:
      - sandol_network

  user-service:
    container_name: sandol_user_service
    build: ./sandol_user_service
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - PYTHONUNBUFFERED=1
    volumes:
      - ./sandol_user_service:/app
      - user_static:/app/static
    networks:
      - sandol_network

  meal-service:
    container_name: sandol_meal_service
    build: ./sandol_meal_service
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - PYTHONUNBUFFERED=1
    volumes:
      - ./sandol_meal_service:/app
    networks:
      - sandol_network

  kakao-bot-service:
    container_name: sandol_kakao_bot_service
    build: ./sandol_kakao_bot_service
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - PYTHONUNBUFFERED=1
    volumes:
      - ./sandol_kakao_bot_service:/app
    networks:
      - sandol_network

  static-info-service:
    container_name: sandol_static_info_service
    build: ./sandol-static-info-service
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - PYTHONUNBUFFERED=1
    volumes:
      - ./sandol-static-info-service:/app
    networks:
      - sandol_network

  notice-notification:
    container_name: sandol-notice-notification
    build:
      context: ./sandol_notice_notification
      dockerfile: Dockerfile
    restart: always

    env_file:
      - ./sandol_notice_notification/sandol_amqp/.env.amqp
      - ./sandol_notice_notification/.env.dev

    ports:
      - "8081:8081"
    networks:
      - sandol_network

    depends_on:
      amqp:
        condition: service_healthy
      notice-notification-db:
        condition: service_healthy

  notice-notification-db:
    container_name: sandol-notice-notification-db
    image: postgres:15
    restart: always
    env_file:
      - ./sandol_notice_notification/.env.dev
    ports:
      - "5432:5432"
    volumes:
      - ./sandol_notice_notification/db_data:/var/lib/postgresql/data
    networks:
      - sandol_network

    healthcheck:
      test: [ "CMD-SHELL", "pg_isready", "-d", "db_prod" ]
      interval: 30s
      timeout: 60s
      retries: 5
      start_period: 80s

  amqp:
    container_name: amqp
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - sandol_network
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "status" ]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  user_static: {}

networks:
  sandol_network:
    driver: bridge
